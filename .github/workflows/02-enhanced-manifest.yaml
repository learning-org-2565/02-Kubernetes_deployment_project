name: 02-Enhanced workflow for deployment

on: 
  workflow_dispatch: 
    inputs:
      action:
        description: "Action to perform on the Kubernetes manifest (apply or delete)"
        default: none
        type: choice
        options:
          - apply
          - delete
        required: true
      gke_cluster_name:
        description: 'select the gke cluster name'
        default: tmproject-dev-private-cluster
        required: true
        type: choice
        options:
          - tmproject-dev-private-cluster
      gcp_project:
        description: 'select the project'
        default: turnkey-guild-441104-f3
        required: true
        type: choice
        options:
          - turnkey-guild-441104-f3


jobs:
  k8s-deployment-2:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the code
        uses: actions/checkout@v4
      
      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ inputs.action.gcp_project }}
          install_components: 'beta'
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Install gke-gcloud-auth-plugin
        run: |
            gcloud components install gke-gcloud-auth-plugin
      
      - name: Authenticate with GKE
        run: |
          gcloud container clusters get-credentials ${{inputs.action.gke_cluster_name}} \
          --region asia-southeast1


      - name: Apply K8s manifest file
        if: ${{ inputs.action == 'apply' }}
        run: |
            kubectl apply -f 02-replicasets.yaml
      - name: Delete the k8s manifest file
        if: ${{ inputs.action == 'delete' }}
        run: |
            kubectl delete -f 02-replicasets.yaml
      
      - name: Check Deployment Rollout Status
        run: |
            kubectl rollout status deployment/nginx-deployment
          
